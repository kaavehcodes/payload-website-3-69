# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Payload CMS Website Template** - a full-stack CMS website built with:
- **Payload CMS 3.69.0** - Headless CMS providing backend and admin panel
- **Next.js 15** with React 19 - Frontend using App Router
- **MongoDB** - Default database (PostgreSQL supported via adapter)
- **TailwindCSS + shadcn/ui** - Styling and components

The frontend and admin panel run together at `http://localhost:3000` (admin at `/admin`).

## Essential Commands

```bash
# Development
pnpm dev              # Start development server
pnpm build            # Build for production
pnpm start            # Run production build
pnpm dev:prod         # Build + start (test production locally)

# Code Quality
pnpm lint             # Run ESLint
pnpm lint:fix         # Fix lint issues
tsc --noEmit          # Validate TypeScript without emitting

# Type Generation (IMPORTANT - run after schema changes)
pnpm generate:types      # Regenerate payload-types.ts
pnpm generate:importmap  # Regenerate admin component import map

# Testing
pnpm test             # Run all tests
pnpm test:int         # Integration tests (Vitest)
pnpm test:e2e         # E2E tests (Playwright)

# Database (PostgreSQL only)
pnpm payload migrate:create   # Create migration
pnpm payload migrate          # Run migrations
```

## Project Structure

```
src/
├── app/
│   ├── (frontend)/        # Public website routes (/, /posts, /[slug])
│   └── (payload)/         # Admin panel (/admin) and API (/api)
├── collections/           # Payload collection configs (Users, Posts, Pages, Media, Categories)
├── globals/               # Global configs (Header, Footer)
├── blocks/                # Layout builder blocks (Hero, Content, MediaBlock, etc.)
├── components/            # React components for frontend and admin
├── access/                # Access control functions
├── hooks/                 # Payload hooks
├── fields/                # Reusable field configurations
└── payload.config.ts      # Main Payload configuration
```

## Critical Security Patterns

### 1. Local API Access Control (MOST IMPORTANT)

By default, Payload Local API **bypasses ALL access control**, even when passing a user:

```typescript
// ❌ BUG: Access control bypassed - user's permissions ignored
await payload.find({
  collection: 'posts',
  user: someUser,
})

// ✅ SECURE: Enforces user's permissions
await payload.find({
  collection: 'posts',
  user: someUser,
  overrideAccess: false, // REQUIRED when passing user
})
```

### 2. Transaction Safety in Hooks

Always pass `req` to nested operations to maintain transaction atomicity:

```typescript
// ❌ DATA CORRUPTION: Runs in separate transaction
await req.payload.create({
  collection: 'audit-log',
  data: { docId: doc.id },
})

// ✅ ATOMIC: Same transaction
await req.payload.create({
  collection: 'audit-log',
  data: { docId: doc.id },
  req, // Pass req for atomicity
})
```

### 3. Prevent Infinite Hook Loops

Use context flags when hooks trigger operations on the same collection:

```typescript
hooks: {
  afterChange: [
    async ({ doc, req, context }) => {
      if (context.skipHooks) return

      await req.payload.update({
        collection: 'posts',
        id: doc.id,
        data: { views: doc.views + 1 },
        context: { skipHooks: true }, // Prevent re-triggering
        req,
      })
    },
  ],
}
```

## Architecture Notes

### Collections
- **Users** - Auth-enabled, admin panel access
- **Posts** - Blog with drafts, versioning, layout builder
- **Pages** - Website pages with layout builder
- **Media** - File uploads with image resizing
- **Categories** - Nested taxonomy (plugin-based)

### Key Plugins
- `@payloadcms/plugin-redirects` - URL redirects with ISR integration
- `@payloadcms/plugin-nested-docs` - Hierarchical categories
- `@payloadcms/plugin-seo` - SEO metadata
- `@payloadcms/plugin-form-builder` - No-code forms
- `@payloadcms/plugin-search` - Full-text search

### Data Flow
1. Content edited in admin panel triggers `afterChange` hooks
2. Hooks call `revalidatePath()` for on-demand ISR
3. Frontend Server Components fetch via Payload Local API
4. Static pages regenerated by Next.js

### Access Control Pattern
Access functions live in `src/access/`:
- `anyone` - Public access
- `authenticated` - Logged-in users
- `authenticatedOrPublished` - Published content OR logged-in user (common for drafts)

## Development Workflow

### Adding a New Collection
1. Create `src/collections/NewCollection.ts`
2. Add to `collections` array in `src/payload.config.ts`
3. Run `pnpm generate:types`
4. Create frontend routes/components as needed

### Adding Admin Components
1. Create component in `src/components/`
2. Reference in `payload.config.ts` under `admin.components`
3. Run `pnpm generate:importmap`

### Adding Layout Builder Blocks
1. Create `src/blocks/MyBlock/config.ts` (Payload config)
2. Create `src/blocks/MyBlock/Component.tsx` (frontend renderer)
3. Add to collection's layout field and `src/blocks/RenderBlocks.tsx`

## Environment Variables

Required in `.env`:
- `DATABASE_URL` - MongoDB connection string
- `PAYLOAD_SECRET` - JWT encryption secret
- `NEXT_PUBLIC_SERVER_URL` - Public URL (no trailing slash)

## Reference Documentation

- **AGENTS.md** - Comprehensive Payload development patterns (access control, hooks, queries, components)
- **.cursor/rules/** - Detailed patterns for collections, fields, access control, components, plugins
- **Payload Docs**: https://payloadcms.com/docs
- **Payload LLM Context**: https://payloadcms.com/llms-full.txt
